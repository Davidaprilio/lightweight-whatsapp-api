<%- include('../layouts/header') %>
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
>
  <h2 class="h2">Your Device</h2>
  <div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
      <button
        type="button"
        class="btn btn-sm btn-outline-dark btn-outline-secondary"
      >
        Share
      </button>
      <button
        type="button"
        class="btn btn-sm btn-outline-dark btn-outline-secondary"
      >
        Export
      </button>
    </div>
    <button
      type="button"
      class="btn btn-sm btn-outline-dark btn-outline-secondary dropdown-toggle"
    >
      <span data-feather="calendar" class="align-text-bottom"></span>
      This week
    </button>
  </div>
</div>

<div class="row justify-content-center container">
  <div class="col-6 col-md-5 col-lg-4">
    <div class="border rounded bg-white shadow-sm p-2 text-center">
      <h5 class="mb-0"><%-device.label%></h5>
      <small
        >status:
        <span id="status-device"
          ><%= device.auth ? 'Connected' : 'Disconnected' %></span
        ></small
      >
      <div class="mt-3" id="container-qrcode">
        <img
          src="https://via.placeholder.com/300"
          alt="image QR"
          class="img-fluid rounded"
        />
      </div>
    </div>
  </div>
  <div class="col-6 col-md-7">
    <div class="card">
      <div class="card-body">
        <ul class="list-group" id="detail-device">
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            Client ID
            <span class="CID badge bg-primary rounded-pill">-</span>
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            Push Name
            <span class="PUSH-NAME badge bg-primary rounded-pill">-</span>
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            Phone Number
            <span class="PHONE-NUMBER badge bg-primary rounded-pill">-</span>
          </li>
          <li
            class="list-group-item d-flex justify-content-between align-items-center"
          >
            Mode
            <span class="MODE badge bg-primary rounded-pill">-</span>
          </li>
        </ul>
      </div>
      <div class="card-footer p-0 text-center d-flex">
        <div
          id="start-device"
          class="btn btn-link text-decoration-none flex-grow-1 rounded-0 border-end"
        >
          Start
        </div>
        <div class="btn btn-link text-decoration-none flex-grow-1 rounded-0">
          Restart
        </div>
        <div
          id="stop-device"
          class="btn btn-link text-decoration-none flex-grow-1 rounded-0 border-start"
        >
          Stop
        </div>
      </div>
    </div>
  </div>
</div>

<!-- <div class="btn-group mt-5">
  <div class="btn btn-sm btn-outline-dark">1</div>
  <div class="btn btn-sm btn-outline-dark"><<</div>
  <div class="btn btn-sm btn-outline-dark">...</div>
  <div class="btn btn-sm btn-outline-dark">7</div>
  <div class="btn btn-sm btn-outline-dark">5</div>
  <div class="btn btn-sm btn-outline-dark">6</div>
  <div class="btn btn-sm btn-outline-dark">...</div>
  <div class="btn btn-sm btn-outline-dark">>></div>
  <div class="btn btn-sm btn-outline-dark">10</div>
</div> -->
<%- include('../layouts/footer-t') %>
<script
  src="https://cdn.socket.io/4.5.0/socket.io.min.js"
  integrity="sha384-7EyYLQZgWBi67fBtVxw60/OWl1kjsfrPFcaU0pp0nAh+i8FD068QogUvg85Ewy1k"
  crossorigin="anonymous"
></script>
<script>
  const socket = io("<%=baseURL%>", {
    autoConnect: false,
  });

  const btnStartDevice = document.getElementById("start-device");
  const btnStopDevice = document.getElementById("stop-device");
  const statusDevice = document.getElementById("status-device");
  const detailContain = document.getElementById("detail-device");
  const qrcodeContain = document.getElementById("container-qrcode");
  const qrImg = document.querySelector("#container-qrcode img");
  const detail = {
    cid: document.querySelector(".CID"),
    pushName: document.querySelector(".PUSH-NAME"),
    phoneNumber: document.querySelector(".PHONE-NUMBER"),
    mode: document.querySelector(".MODE"),
  };

  btnStartDevice.addEventListener("click", () => {
    socket.emit("device-start");
  });

  btnStopDevice.addEventListener("click", () => {
    const isMultidevice = true;
    socket.emit("device-stop", isMultidevice);
  });

  socket.auth = {
    cid: "<%=device.cid%>",
  };
  socket.connect();

  socket.on("connect", () => {
    console.log("connected");
    socket.emit("listen-device", socket.auth.cid);
  });
  socket.on("disconnect", () => {
    console.log("disconnected");
  });
  socket.on("listened.device", () => {
    console.log("device listened");
    socket.emit("device-info");
  });

  socket.on("joined", (data) => {
    console.log("joined", data);
  });

  socket.on("device.connected", (data, mode) => {
    statusDevice.innerText = "Connected";
    statusDevice.classList.add("text-success");
    statusDevice.classList.remove("text-danger");
    detail.pushName.innerText = data.pushName;
    detail.phoneNumber.innerText = data.phoneNumber;
    detail.cid.innerText = data.id;
    qrImg.setAttribute("src", data.ppURL);
    detail.mode.innerText = data.mode == "md" ? "Multi Device" : "Legacy";
  });
  socket.on("qrcode.update", (data) => {
    console.log("QRcode:", data);
  });
  socket.on("qrcode.stop", () => {
    console.log("QRcode STOP");
  });
</script>
<%- include('../layouts/footer-b') %>
